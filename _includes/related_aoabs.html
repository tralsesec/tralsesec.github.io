{% assign max_related = 3 %}
{% assign all_scores = "" %}

{% comment %} 1. Calculate scores and gather matches {% endcomment %}
{% for aoab in site['anatomy-of-a-bug'] %}
  {% if aoab.url != page.url %}
    {% assign score = 0 %}
    {% assign matched_tags = "" %}
    
    {% comment %} Sort tags alphabetically before iterating {% endcomment %}
    {% assign sorted_tags = aoab.tags | sort %}

    {% for tag in sorted_tags %}
      {% if page.tags contains tag %}
        {% capture matched_tags %}{{ matched_tags }}{{ tag }} {% endcapture %}
        
        {% comment %} 
           SCORE BOOSTING: 
           Wir geben RCE/Kernel mehr Punkte für die SORTIERUNG,
           aber wir nutzen das später NICHT mehr für die Prozentanzeige!
        {% endcomment %}
        {% if tag == "Kernel" or tag == "RCE" or tag == "LPE" or tag == "Heap" %}
          {% assign score = score | plus: 3 %}
        {% else %}
          {% assign score = score | plus: 1 %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% if score > 0 %}
      {% capture score_item %}{{ score | prepend: '00' | slice: -3, 3 }}|{{ forloop.index0 }}|{{ matched_tags | rstrip }}{% endcapture %}
      {% assign all_scores = all_scores | append: score_item | append: ":::" %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %} 2. Only render if matches exist {% endcomment %}
{% if all_scores != "" %}
  {% assign sorted_scores = all_scores | split: ":::" | sort | reverse %}

  <style>
    .tooltip { position: relative; display: inline-block; cursor: help; }
    .tooltip .tooltiptext {
      visibility: hidden; width: 200px; background-color: #1a1a1a; color: #fff;
      text-align: left; border: 1px solid var(--accent); padding: 8px; position: absolute;
      z-index: 10; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0;
      transition: opacity 0.3s; font-family: var(--font-mono); font-size: 0.65rem; line-height: 1.4;
      pointer-events: none;
    }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
  </style>

  <div class="related-aoabs" style="margin-top: 0rem; border-top: 0px solid var(--border); padding-top: 0rem;">
    <h3 style="color: var(--accent); margin-bottom: 1.5rem; font-family: var(--font-mono);">// RELATED_INTELLIGENCE</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
      
      {% for entry in sorted_scores limit:max_related %}
        {% assign parts = entry | split: "|" %}
        {% assign score = parts[0] | plus: 0 %}
        {% assign aoab_index = parts[1] | plus: 0 %}
        {% assign current_matches = parts[2] %}
        
        {% assign aoab = site['anatomy-of-a-bug'][aoab_index] %}

        {% assign raw_id = aoab.id | split: "/" | last %}
        {% assign clean_id = raw_id | plus: 0 %}
        {% assign img_url = "/anatomy-of-a-bug/assets/og/" | append: clean_id | append: ".png" | relative_url %}

        {% comment %} FIX: Calculate Percentage based on COUNT, not SCORE {% endcomment %}
        {% assign total_tags = page.tags | size | fallback: 1 %}
        {% assign real_match_count = current_matches | split: " " | size %}
        {% assign match_percent = real_match_count | times: 100 | divided_by: total_tags | at_most: 100 %}

        <div class="related-card" style="border: 1px solid #222; background: #0a0a0a; display: flex; align-items: center; padding: 0.8rem; gap: 1rem; position: relative;">
          
          <div style="width: 60px; height: 60px; flex-shrink: 0; border: 1px solid #333; overflow: hidden;">
            <img src="{{ img_url }}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;">
          </div>

          <div style="flex-grow: 1;">
            <div style="display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 0.6rem;">
              <span class="fg-dim">CVE-REPORT</span>
              <span style="color: {% if aoab.severity == 'Critical' %}#ff0055{% elsif aoab.severity == 'High' %}#ff4d4d{% elsif aoab.severity == 'Medium' %}#ffa500{% elsif aoab.severity == 'Low' %}#00ff00{% else %}#888{% endif %}; font-weight: bold;">
                {{ aoab.severity | upcase }}
              </span>
            </div>
            
            <h4 style="margin: 3px 0; line-height: 1.2;">
                <a href="{{ aoab.url }}" style="border: none; font-size: 0.9rem; color: #eee;">{{ aoab.title }}</a>
            </h4>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
              <div style="width: 80px; height: 4px; background: #222; border-radius: 2px;">
                <div style="width: {{ match_percent }}%; height: 100%; background: var(--accent);"></div>
              </div>
              <span style="font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent);">
                {{ match_percent }}% LINKED
              </span>
              
              <div class="tooltip">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5; vertical-align: middle;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span class="tooltiptext">
                  <strong style="color: var(--accent); display: block; margin-bottom: 5px;">SHARED_VECTORS:</strong>
                  {{ current_matches | replace: " ", "<br>• " | prepend: "• " }}
                </span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}
